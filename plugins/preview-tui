#!/usr/bin/env sh

# Description: Text based file previewer
#
# Note: This plugin needs a "NNN_FIFO" to work.
#
# Dependencies: tmux (>=3.0) or xterm or $TERMINAL, less or $PAGER, file, tree
#
# Usage:
#   You need to set a NNN_FIFO path and set a key for the plugin,
#   then start `nnn`:
#
#     $ NNN_FIFO=/tmp/nnn.fifo nnn
#
#   Then in `nnn`, launch the `preview-tui` plugin.
#
#   If you provide the same NNN_FIFO to all nnn instances, there will be a
#   single common preview window. I you provide different FIFO path, they
#   will be independent.
#
# Shell: POSIX compliant
# Authors: Todd Yamakawa, LÃ©o Villeveygoux

TERMINAL="${TERMINAL:-xterm}"
PAGER="${PAGER:-less -r}"

preview_file () {
    kill "$(jobs -p)" 2>/dev/null
    clear

    encoding="$(file -b --mime-encoding "$1")"
    typ="$(file -b "$1" | sed 's/ .*//')"

    if [ -d "$1" ]; then
        # Print directory tree

        cd "$1" || return

        # we use a FIFO to access less PID
        tmpfifopath="${TMPDIR:-/tmp}/nnn-preview-tui-fifo.$$"
        mkfifo "$tmpfifopath" || return

        $PAGER < "$tmpfifopath" &

        (
            exec > "$tmpfifopath"
            tree&
        )

        rm "$tmpfifopath"
     elif [ "$typ" = "Zip" ] && [ $(command -v zip) ]; then
     	# Display content of Zip
     	zip -sf "$1" | $PAGER &
     elif [ "$typ" = "gzip" ] && [ $(command -v tar) ]; then
     	# Display content of archive
     	tar -tvf "$1" | $PAGER &
     elif [ "$typ" = "PDF" ] && [ $(command -v pdftotext) ]; then
     	# Display content of PDF
     	pdftotext "$1" - | $PAGER &
     elif ( [ "$typ" = "PNG" ] || [ "$typ" = "JPEG" ] ) && [ $(command -v viu) ]; then
     	# Display image in terminal (more or less lowered resolution)
     	viu "$1" | head -n $lines
    elif [ "$encoding" = "binary" ] ; then
        # Binary file: just print filetype info
        echo "-------- Binary file --------"
        file -b "$1"
	echo "------- Informations -------"
	stat "$1"
    else
        # Text file:
	if [ $(command -v highlight) ]; then
		highlight --out-format=ansi --force "$1" | $PAGER &
	else
		$PAGER "$1" &
	fi
    fi
}

if [ "$PREVIEW_MODE" ] ; then
    if [ ! -r "$NNN_FIFO" ] ; then
        echo "No FIFO available! (\$NNN_FIFO='$NNN_FIFO')" >&2
        read -r
        exit 1
    fi

    preview_file "$1"

    exec < "$NNN_FIFO"
    while read -r selection ; do
        preview_file "$selection"
    done
    exit 0
fi

if [ -e "${TMUX%%,*}" ] && [ "$(tmux -V | cut -c6)" -eq 3 ] ; then
   printf "split 'h'orizontal/'v'ertical :"
   read -r spl
   case $spl in
   	h*) tmux split-window -e "NNN_FIFO=$NNN_FIFO" -e "PREVIEW_MODE=1" -dh "$0" "$1"
   		;;
   	v*) tmux split-window -e "NNN_FIFO=$NNN_FIFO" -e "PREVIEW_MODE=1" -d "$0" "$1"
   		;;
   	*) tmux split-window -e "NNN_FIFO=$NNN_FIFO" -e "PREVIEW_MODE=1" -dh "$0" "$1"
   		;;
   esac
else
    PREVIEW_MODE=1 $TERMINAL -e "$0" "$1" &
fi
