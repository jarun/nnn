#!/usr/bin/env sh

# Description: Text based file previewer
#
# Note: This plugin needs a "NNN_FIFO" to work.
#
# Dependencies: tmux (>=3.0) or xterm or $TERMINAL, less or $PAGER,
#               file, stat, tree, man, tar, unzip, ...
#                      ... add you own! (see examples in code)
#
# Usage:
#   You need to set a NNN_FIFO path and set a key for the plugin,
#   then start `nnn`:
#
#     $ nnn -a
#
#   or
#
#     $ NNN_FIFO=/tmp/nnn.fifo nnn
#
#   Then in `nnn`, launch the `preview-tui` plugin.
#
#   If you provide the same NNN_FIFO to all nnn instances, there will be a
#   single common preview window. I you provide different FIFO path (e.g.
#   with -a), they will be independent.
#
#   Configure SPLIT to either "h" or "v" to set a 'h'orizontal split or a
#   'v'ertical split
#
# Shell: POSIX compliant
# Authors: Todd Yamakawa, LÃ©o Villeveygoux, @Recidiviste

SCOPE_SCRIPT="${XDG_CONFIG_HOME:-$HOME/.config}/nnn/plugins/scope.sh"
PAGER="${PAGER:-less -R}"

if [ -e "${TMUX%%,*}" ] && tmux -V | grep -q '[ -][3456789]\.'; then
    TERMINAL=tmux
elif [ -n "$KITTY_WINDOW_ID" ] && kitty @ ls >/dev/null 2>&1; then
    TERMINAL=kitty
else
    TERMINAL="${TERMINAL:-xterm}"
fi

exists() {
    command -v "$1" >/dev/null 2>&1
}

fifo_pager() {
    cmd="$1"
    shift

    # We use a FIFO to access $PAGER PID in jobs control
    tmpfifopath="${TMPDIR:-/tmp}/nnn-preview-tui-fifo.$$"
    mkfifo "$tmpfifopath" || return

    $PAGER < "$tmpfifopath" &

    (
        exec > "$tmpfifopath"
        "$cmd" "$@" &
    )

    rm "$tmpfifopath"
}

preview_file () {
    kill %- %+ 2>/dev/null && wait %- %+ 2>/dev/null
    clear

    # Detecting the exact type of the file: the encoding, mime type, and
    # extension in lowercase.
    encoding="$(file -Lb --mime-encoding -- "$1")"
    mimetype="$(file -Lb --mime-type -- "$1")"
    ext="${1##*.}"
    if [ -n "$ext" ]; then
        ext="$(printf "%s" "${ext}" | tr '[:upper:]' '[:lower:]')"
    fi
    lines=$(($(tput lines)-1))
    cols=$(tput cols)

    # Trying to use scope.sh if it's available.
    if [ -x "$SCOPE_SCRIPT" ]; then
        fifo_pager "$SCOPE_SCRIPT" "$1" "$cols" "$lines" "$(mktemp -d)" \
            "True" 2>/dev/null
        return
    fi

    # Otherwise, falling back to the defaults.
    if [ -d "$1" ]; then
        cd "$1" || return
        if exists tree; then
            fifo_pager tree
        elif exists exa; then
            fifo_pager exa -G --colour=always 2>/dev/null
        else
            fifo_pager ls --color=always
        fi
    elif [ "$encoding" = "binary" ]; then
        if [ "${mimetype%%/*}" = "image" ] ; then
            if [ "$TERMINAL" = "kitty" ]; then
                # Kitty terminal users can use the native image preview method.
                kitty +kitten icat --silent --transfer-mode=stream --stdin=no \
                    "$1" &
            elif exists catimg; then
                catimg "$1"
            fi
        elif [ "$mimetype" = "application/zip" ] ; then
            fifo_pager unzip -l "$1"
        elif [ "$ext" = "gz" ] || [ "$ext" = "bz2" ] ; then
            fifo_pager tar -tvf "$1"
        else
            # Binary file: show file info inside the pager
            print_bin_info() {
                printf -- "-------- \033[1;31mBinary file\033[0m --------\n"
                if exists mediainfo; then
                    mediainfo "$1" 2>/dev/null
                else
                    file -b "$1"
                fi
            }
            fifo_pager print_bin_info "$1"
        fi
    elif [ "$mimetype" = "text/troff" ] ; then
        fifo_pager man -Pcat -l "$1"
    else
        if exists bat; then
            fifo_pager bat --paging=never --decorations=always --color=always \
                "$1" 2>/dev/null
        else
            $PAGER "$1" &
        fi
    fi
}

if [ "$PREVIEW_MODE" ] ; then
    if [ ! -r "$NNN_FIFO" ] ; then
        echo "No FIFO available! (\$NNN_FIFO='$NNN_FIFO')" >&2
        read -r
        exit 1
    fi

    preview_file "$1"

    # use cat instead of 'exec <' to avoid issues with dash shell
    # shellcheck disable=SC2002
    cat "$NNN_FIFO" |\
    while read -r selection ; do
        preview_file "$selection"
    done
    exit 0
fi

if [ "$TERMINAL" = "tmux" ]; then
    if [ -z "$SPLIT" ] && [ $(($(tput lines) * 2)) -gt "$(tput cols)" ] ; then
        SPLIT='v'
    elif [ "$SPLIT" != 'v' ] ; then
        SPLIT='h'
    fi

    tmux split-window -e "NNN_FIFO=$NNN_FIFO" -e "PREVIEW_MODE=1" -d"$SPLIT" "$0" "$1"
elif [ "$TERMINAL" = "kitty" ]; then
    # Trying to use kitty's integrated window management as the split window.
    kitty @ launch --no-response --title "nnn preview" --keep-focus \
          --cwd="$PWD" --env "NNN_FIFO=$NNN_FIFO" --env "PREVIEW_MODE=1" \
          "$0" "$1" > /dev/null
else
    PREVIEW_MODE=1 $TERMINAL -e "$0" "$1" &
fi
