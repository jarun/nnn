#!/usr/bin/env bash

# Description: unmount a nnn remote mountpoint from any of its subfolders (vanilla `u` in nnn requires either
# going back to ~/.config/nnn/mounts to hover the mountpoint, or to enter its name in the `u` prompt)
#
# Dependencies: fusermount
# Shell: bash
# Authors: Kabouik & 0xACE

# ENVIRONMENT
err=0
m=$HOME/.config/nnn/mounts
if [ "$PWD" = "$m" ]; then  # ALLOW USING THE SCRIPT ON HOVERED DIRECTORY IF USER IS IN ~/.config/nnn/mounts
    d="$1"
else
    d=$(echo "$(dirname "$(readlink -f "$1")")" | grep -oP "^$m\K.*" | cut -d"/" -f2)
fi

# TEST IF USER IS CURRENTLY WITHIN $m OR A SUBFOLDER, ABORT IF NOT
    if [ "$d" = "" ]; then
        clear && read -n 1 -s -r -p "You are not in folder mounted with nnn. Press any key to continue."
    else
        # TEST IF $m/$d IS A MOUNTPOINT AND TRY UNMOUNTING IF YES
        mountpoint -q -- "$m/$d"
        if [ "$?" -eq "1" ]; then
            clear && read -n 1 -s -r -p "Parent '$d' is not a mountpoint. Press any key to continue."
        else
            cd "$m" && fusermount -uq "$m/$d" || err=1
            if [ "$err" -eq "0" ]; then
                rmdir "$m/$d" && clear && printf "Parent '%s' unmounted." "$d"
            else
                clear && read -n 1 -s -r -p "Failed to unmount. Try lazy unmount? Yy/Nn"
            fi
        fi
    fi

# IF FAILURE TO UNMOUNT, OFFER TO TRY LAZY UNMOUNT
    if [ "$REPLY" = "y" ] || [ "$REPLY" = "Y" ]; then 
        err=0
        cd "$m" && fusermount -uqz "$m/$d" || err=1
        if [ "$err" -eq "0" ]; then
            rmdir "$m/$d" && clear && printf "Parent '%s' unmounted with lazy unmount." "$d"
        fi
    fi
