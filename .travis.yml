language: c
sudo: required
services:
  - docker
env:
  global:
    - REPO=nnn

matrix:
  include:
    # Access more recent gcc and clang via a Trusty image
    - os: linux
      dist: trusty
      compiler: gcc
    - os: linux
      dist: trusty
      compiler: clang
    - os: osx
      compiler: gcc
    - os: osx
      compiler: clang

script:
  - export CFLAGS=-Werror;
  - make clean; make;
  - make clean;

before_deploy:
  - cd ..
  - rm -rf $REPO/.git
  - tar -czf $REPO-${TRAVIS_TAG}.tar.gz $REPO
  - cd $REPO
  - unset CFLAGS
  - sudo apt-get update -qy
  - sudo apt-get install -qy python3 python3-pip
  - sudo python3 -m pip install packagecore
  - packagecore -o dist/ "${TRAVIS_TAG#v}"
  - mv ../$REPO-${TRAVIS_TAG}.tar.gz dist/

deploy:
  provider: releases
  api-key:
    secure: FHqM8kqf7S63kdBt0ET7XepyqO61LUQMpgEjDaU5FoAQlW3kZkJj6PizP26Q9BnnW3J7X197jGF+h4SSkMsfntoR8w8mAMMAlz3MLoxEmyzoWpqmWT8NU8TQJ31KGVihLMWqRuRdRgekqF1bnXAhXbuygMIZ/Q/g2JStSrUjPGf4Mxa5fbR/RYyTMsyP3AYnGdAjURxCyd5OjiEPCuTB5M5rjFF+uhTRXbPeJQQtm/IjaGUSz0VOGTsACAC8aP3unPo38S9+/rOdXOG2VAqRxSi4RXGO3jWvovV/1ugMVEcVwv9baka1+GXvoMdB823DeG2rzlRtC6AYrWN7oj6j+y33Lx8X9Tix6IPiydUZpXGNv/yUqkbN5ll5uge8Z/E+ApPr+nTfPp/NxlISeNmZBLk8gqPkB6abzpdN12gYdmAk4cra3QbyqOB71bLSXEah77sTuW8A0J0zGmYJZXtxzotiK0bJzWknfB2BDVqozhgQqL/C0wScBbIxlo+sUd1M1IVzi+9tLwr21XlfrLJrBpgJ/D9WdvrXzRYLZeeizX5j3ZCxh5wAVd4SkFpwx0G5xrLv6Eb9JT5zv8d7zvM9wU82dzgV2axU1S/uCggDoKUlvIuhAMA4gBjs8OK709q0GSjrQrK3HjG+Nn0JxXyvuYllScI4ie4gd0hXfNaonLw=
  file_glob: true
  file:
    - dist/*
  skip_cleanup: true
  on:
    condition:
      - "$TRAVIS_OS_NAME == linux"
      - "$CC == gcc"
    tags: true
    repo: jolpaz/nnn
